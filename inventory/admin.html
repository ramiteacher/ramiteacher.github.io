<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š ê´€ë¦¬ì í†µê³„ ì‹œê°í™”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    canvas { background-color: #fff; border-radius: 12px; box-shadow: 0 0 10px #0003; }
    h2 { color: #00f0ff; margin-bottom: 4px; }
    #sheetName a { color: #00ff88; text-decoration: underline; font-size: 0.95rem; }
    #chart-container { max-width: 900px; margin: 0 auto; padding: 12px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
    .controls select, .controls button { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: #fff; }
    .controls button { cursor: pointer; display: flex; align-items: center; }
    .controls button:hover { background-color: #f5f5f5; }
    .controls button svg { margin-right: 5px; }
    #dataTable { margin-top: 20px; width: 100%; border-collapse: collapse; }
    #dataTable th, #dataTable td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    #dataTable th { background-color: #f2f2f2; position: sticky; top: 0; }
    #dataTable tbody tr:hover { background-color: #f5f5f5; }
    .table-container { max-height: 400px; overflow-y: auto; margin-top: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .tab-buttons { display: flex; gap: 5px; margin: 15px 0; }
    .tab-button { padding: 8px 15px; border: none; background: #eee; border-radius: 5px; cursor: pointer; }
    .tab-button.active { background: #00b894; color: white; }
    .tabs { margin-top: 15px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <h2>ğŸ“Š í’ˆëª©ë³„ ì…ì¶œê³  í†µê³„</h2>
  <div id="sheetName">ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  
  <div id="chart-container">
    <div class="controls">
      <select id="chartType">
        <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
        <option value="line">ì„  ê·¸ë˜í”„</option>
        <option value="pie">íŒŒì´ ì°¨íŠ¸</option>
        <option value="radar">ë ˆì´ë” ì°¨íŠ¸</option>
      </select>
      
      <select id="itemFilter">
        <option value="all">ëª¨ë“  í’ˆëª©</option>
      </select>
      
      <button id="downloadCSV">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 12l-4-4h2.5V2h3v6H12L8 12z"/>
          <path d="M14 13v1H2v-1h12z"/>
        </svg>
        CSV ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
    
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="chart">ì°¨íŠ¸ ë³´ê¸°</button>
      <button class="tab-button" data-tab="table">ë°ì´í„° í…Œì´ë¸”</button>
    </div>
    
    <div class="tabs">
      <div class="tab-content active" id="chart-tab">
        <canvas id="chartCanvas"></canvas>
      </div>
      <div class="tab-content" id="table-tab">
        <div class="table-container">
          <table id="dataTable">
            <thead>
              <tr>
                <th>í’ˆëª©</th>
                <th>ì…ê³ </th>
                <th>ì¶œê³ </th>
                <th>ë°˜í’ˆ</th>
                <th>í•˜ì</th>
                <th>ì¬ê³ </th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sheetId = new URLSearchParams(location.search).get("sheetId");
    let rawData = [];
    let chart = null;

    async function getAccessToken() {
      return new Promise((resolve) => {
        const cached = localStorage.getItem("accessToken");
        if (cached) return resolve(cached);
        google.accounts.oauth2.initTokenClient({
          client_id: "192783618509-d0ev6sp714cr4d43cfumfaum005g485t.apps.googleusercontent.com",
          scope: "https://www.googleapis.com/auth/spreadsheets.readonly",
          callback: (res) => {
            localStorage.setItem("accessToken", res.access_token);
            resolve(res.access_token);
          }
        }).requestAccessToken();
      });
    }

    async function fetchSheetData() {
      const token = await getAccessToken();
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/ì…ì¶œê³ ê¸°ë¡!A2:F1000`;
      const res = await fetch(url, {
        headers: { Authorization: "Bearer " + token }
      });
      const json = await res.json();
      rawData = json.values || [];
      return rawData;
    }

    async function fetchSheetTitle() {
      try {
        // OAuth í† í°ì„ ì‚¬ìš©í•˜ì—¬ ì‹œíŠ¸ ì •ë³´ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
        const token = await getAccessToken();
        
        if (!token) {
          throw new Error('ì¸ì¦ í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=properties.title`,
          { headers: { Authorization: `Bearer ${token}` } }
        );
        
        if (!response.ok) {
          throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        
        const data = await response.json();
        const title = data.properties?.title || '(ì´ë¦„ ì—†ìŒ)';
        
        document.getElementById("sheetName").innerHTML =
          `ğŸ“„ ì‹œíŠ¸: <strong>${title}</strong> <a href="https://docs.google.com/spreadsheets/d/${sheetId}" target="_blank">[ì—´ê¸°]</a>`;
      } catch (error) {
        console.error("ì‹œíŠ¸ ì œëª© ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        document.getElementById("sheetName").innerHTML = 
          `âŒ ì‹œíŠ¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ <small>(${error.message})</small>`;
      }
    }

    function summarizeByItem(data) {
      const summary = {};
      for (const row of data) {
        const name = row[2];
        const qty = parseInt(row[3]) || 1;
        const type = row[5];

        if (!summary[name]) {
          summary[name] = { ì…ê³ : 0, ì¶œê³ : 0, ë°˜í’ˆ: 0, í•˜ì: 0 };
        }
        if (summary[name][type] !== undefined) {
          summary[name][type] += qty;
        }
      }
      return summary;
    }

    function populateItemFilter(summary) {
      const select = document.getElementById('itemFilter');
      // ê¸°ì¡´ ì˜µì…˜ ì‚­ì œ (ì²« ë²ˆì§¸ "ëª¨ë“  í’ˆëª©" ì œì™¸)
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // í’ˆëª©ë³„ ì˜µì…˜ ì¶”ê°€
      Object.keys(summary).sort().forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }

    function renderDataTable(summary) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      
      // ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedItems = Object.keys(summary).sort();
      
      sortedItems.forEach(item => {
        const row = document.createElement('tr');
        const data = summary[item];
        const stock = data.ì…ê³  - data.ì¶œê³  - data.í•˜ì; // ì¬ê³  = ì…ê³  - ì¶œê³  - í•˜ì
        
        row.innerHTML = `
          <td>${item}</td>
          <td>${data.ì…ê³ }</td>
          <td>${data.ì¶œê³ }</td>
          <td>${data.ë°˜í’ˆ}</td>
          <td>${data.í•˜ì}</td>
          <td>${stock}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderChart(summary, chartType = 'bar', itemFilter = 'all') {
      const ctx = document.getElementById("chartCanvas").getContext('2d');
      
      let labels = Object.keys(summary);
      
      // í’ˆëª© í•„í„° ì ìš©
      if (itemFilter !== 'all') {
        labels = labels.filter(item => item === itemFilter);
      }
      
      // ì´ë¦„ìˆœ ì •ë ¬
      labels.sort();
      
      const datasets = [];
      
      if (chartType === 'pie' || chartType === 'radar') {
        // íŒŒì´/ë ˆì´ë” ì°¨íŠ¸ëŠ” ê° ìœ í˜•(ì…ê³ ,ì¶œê³ ,ë°˜í’ˆ,í•˜ì)ë³„ë¡œ ë‹¤ë¥¸ ì°¨íŠ¸ë¥¼ ë³´ì—¬ì¤Œ
        const dataTypes = ['ì…ê³ ', 'ì¶œê³ ', 'ë°˜í’ˆ', 'í•˜ì'];
        const colorMap = {
          'ì…ê³ ': '#00b894',
          'ì¶œê³ ': '#d63031',
          'ë°˜í’ˆ': '#0984e3',
          'í•˜ì': '#ffb6c1'
        };
        
        dataTypes.forEach(type => {
          datasets.push({
            label: type,
            data: labels.map(l => summary[l][type]),
            backgroundColor: colorMap[type],
            borderColor: colorMap[type]
          });
        });
      } else {
        // ë§‰ëŒ€/ì„  ê·¸ë˜í”„ëŠ” ëª¨ë“  ìœ í˜•ì„ í•˜ë‚˜ì˜ ì°¨íŠ¸ì— í‘œì‹œ
        datasets.push(
          { label: 'ì…ê³ ', data: labels.map(l => summary[l].ì…ê³ ), backgroundColor: '#00b894', borderColor: '#00b894' },
          { label: 'ì¶œê³ ', data: labels.map(l => summary[l].ì¶œê³ ), backgroundColor: '#d63031', borderColor: '#d63031' },
          { label: 'ë°˜í’ˆ', data: labels.map(l => summary[l].ë°˜í’ˆ), backgroundColor: '#0984e3', borderColor: '#0984e3' },
          { label: 'í•˜ì', data: labels.map(l => summary[l].í•˜ì), backgroundColor: '#ffb6c1', borderColor: '#ffb6c1' }
        );
      }
      
      // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´
      if (chart) {
        chart.destroy();
      }
      
      // ì°¨íŠ¸ ì˜µì…˜ ì„¤ì •
      const options = {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'ğŸ“¦ í’ˆëª©ë³„ ì…ì¶œê³ /í•˜ì/ë°˜í’ˆ í†µê³„' }
        }
      };
      
      // ì°¨íŠ¸ íƒ€ì…ë³„ ì¶”ê°€ ì˜µì…˜
      if (chartType === 'bar') {
        options.scales = {
          x: { stacked: false },
          y: { beginAtZero: true }
        };
      }
      
      // ì°¨íŠ¸ ìƒì„±
      chart = new Chart(ctx, {
        type: chartType,
        data: {
          labels,
          datasets
        },
        options
      });
    }
    
    function convertToCSV(summary) {
      // CSV í—¤ë”
      let csv = 'í’ˆëª©,ì…ê³ ,ì¶œê³ ,ë°˜í’ˆ,í•˜ì,ì¬ê³ \n';
      
      // ê° í–‰ ë°ì´í„° ì¶”ê°€
      Object.keys(summary).sort().forEach(item => {
        const data = summary[item];
        const stock = data.ì…ê³  - data.ì¶œê³  - data.í•˜ì;
        csv += `"${item}",${data.ì…ê³ },${data.ì¶œê³ },${data.ë°˜í’ˆ},${data.í•˜ì},${stock}\n`;
      });
      
      return csv;
    }
    
    function downloadCSV(csv, filename = 'inventory-data.csv') {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.display = 'none';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function run() {
      if (!sheetId) {
        document.getElementById("sheetName").innerText = "âŒ sheetId ëˆ„ë½";
        return;
      }
      
      await fetchSheetTitle();
      const raw = await fetchSheetData();
      const summary = summarizeByItem(raw);
      
      // í’ˆëª© í•„í„° ì˜µì…˜ ì±„ìš°ê¸°
      populateItemFilter(summary);
      
      // ê¸°ë³¸ ì°¨íŠ¸ ë Œë”ë§
      renderChart(summary);
      
      // ë°ì´í„° í…Œì´ë¸” ë Œë”ë§
      renderDataTable(summary);
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      document.getElementById('chartType').addEventListener('change', e => {
        const chartType = e.target.value;
        const itemFilter = document.getElementById('itemFilter').value;
        renderChart(summary, chartType, itemFilter);
      });
      
      document.getElementById('itemFilter').addEventListener('change', e => {
        const chartType = document.getElementById('chartType').value;
        const itemFilter = e.target.value;
        renderChart(summary, chartType, itemFilter);
      });
      
      document.getElementById('downloadCSV').addEventListener('click', () => {
        const csv = convertToCSV(summary);
        downloadCSV(csv, `inventory-data-${new Date().toISOString().slice(0,10)}.csv`);
      });
      
      // íƒ­ ì „í™˜ ê¸°ëŠ¥
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          // ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
          document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // ëª¨ë“  íƒ­ ì½˜í…ì¸ ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          
          // í´ë¦­ëœ ë²„íŠ¼ê³¼ í•´ë‹¹ íƒ­ì— active í´ë˜ìŠ¤ ì¶”ê°€
          button.classList.add('active');
          const tabId = button.dataset.tab + '-tab';
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    run();
  </script>
</body>
</html>